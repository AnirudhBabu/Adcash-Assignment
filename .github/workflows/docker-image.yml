name: Build, Push & Deploy Gandalf Image

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set Image Tags
      run: |
        REPO=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
        IMAGE=ghcr.io/$REPO/gandalf-app
        echo "IMAGE=$IMAGE" >> $GITHUB_ENV
        echo "TAG=${{ github.sha }}" >> $GITHUB_ENV
        echo "LATEST_TAG=$IMAGE:latest" >> $GITHUB_ENV
        echo "COMMIT_TAG=$IMAGE:${{ github.sha }}" >> $GITHUB_ENV

    - name: Show Image Tags
      run: |
        echo "Latest: $LATEST_TAG"
        echo "Commit: $COMMIT_TAG"

    - name: Log in to GHCR
      run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

    - name: Build Docker Images
      run: |
        docker build . -t $LATEST_TAG -t $COMMIT_TAG

    - name: Push Docker Images
      run: |
        docker push $LATEST_TAG
        docker push $COMMIT_TAG

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Set AKS Context
      run: |
        az aks get-credentials \
          --resource-group Adcash_Assignment \
          --name GandalfCluster \
          --overwrite-existing
          
    - name: Run Ansible Playbook
      run: |
        ansible-playbook ./deployGandalf.yaml -e "image_tag=${{ github.sha }}"

    - name: Trigger Kubernetes Redeploy
      run: |
        kubectl set image deployment/gandalf-app gandalf=$LATEST_TAG
        kubectl rollout status deployment/gandalf-app
